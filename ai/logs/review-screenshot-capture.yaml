review:
  name: screenshot-capture
  commit: 9f57fdb
  date: 2025-12-21
  scope: Screenshot capture tools implementation
  focus: DRY and SOLID principles adherence

summary:
  build_status: PASS
  test_status: PASS (15/15)
  files_reviewed: 11
  overall_quality: GOOD

findings:

  - id: DRY-001
    severity: major
    category: DRY Violation
    title: Duplicated image processing logic in GDScript
    description: |
      The resize and encode logic is duplicated between capture_game_screenshot
      and capture_editor_screenshot functions (lines 24-30 and 57-63).
      Both functions perform identical operations:
      - Resize image if exceeds max_width
      - Save to PNG buffer
      - Encode to base64
      - Return success dict with image_base64, width, height
    file: godot/addons/godot_mcp/commands/screenshot_commands.gd
    lines: [24-36, 55-69]
    recommendation: |
      Extract a helper function:
      func _capture_and_encode(image: Image, max_width: int) -> Dictionary
    owner: TODO

  - id: DRY-002
    severity: minor
    category: DRY Violation
    title: Duplicated response type definition in TypeScript
    description: |
      The response type { image_base64, width, height } is defined inline
      twice in screenshot.ts (lines 16-19 and 44-47).
    file: server/src/tools/screenshot.ts
    lines: [16-19, 44-47]
    recommendation: |
      Define a shared type:
      type ScreenshotResponse = {
        image_base64: string;
        width: number;
        height: number;
      };
    owner: TODO

  - id: DRY-003
    severity: minor
    category: DRY Violation
    title: Duplicated ImageContent construction
    description: |
      The ImageContent object construction is duplicated in both tool
      execute functions (lines 22-26 and 50-54).
    file: server/src/tools/screenshot.ts
    lines: [22-26, 50-54]
    recommendation: |
      Extract helper:
      function toImageContent(base64: string): ImageContent
    owner: TODO

  - id: SRP-001
    severity: minor
    category: Single Responsibility Principle
    title: Viewport finding logic mixed with screenshot logic
    description: |
      MCPScreenshotCommands handles both viewport discovery and screenshot
      capture. The viewport finding functions (_find_2d_viewport,
      _find_3d_viewport, _find_viewport_in_tree) could be extracted to a
      utility class for reuse.
    file: godot/addons/godot_mcp/commands/screenshot_commands.gd
    lines: [72-101]
    recommendation: |
      Consider moving viewport utilities to mcp_utils.gd or a new
      viewport_utils.gd file for potential reuse by other commands.
    owner: TODO

  - id: UNUSED-001
    severity: nit
    category: Dead Code
    title: Unused hint parameter in _find_viewport_in_tree
    description: |
      The 'hint' parameter in _find_viewport_in_tree is passed but never
      used. It was intended to differentiate 2D vs 3D viewports but the
      implementation just returns the first SubViewport found.
    file: godot/addons/godot_mcp/commands/screenshot_commands.gd
    lines: [89]
    recommendation: |
      Either use the hint to filter viewports by type, or remove the
      parameter to avoid confusion.
    owner: TODO

  - id: ERR-001
    severity: minor
    category: Error Handling
    title: No null check for image capture
    description: |
      get_texture().get_image() could potentially return null in edge
      cases (e.g., viewport not yet rendered). No null check before
      calling image methods.
    file: godot/addons/godot_mcp/commands/screenshot_commands.gd
    lines: [22, 55]
    recommendation: |
      Add null check:
      if image == null:
        return _error("CAPTURE_FAILED", "Failed to capture image")
    owner: TODO

  - id: DOC-001
    severity: nit
    category: Documentation
    title: capture_game_screenshot description is misleading
    description: |
      The description says "running game viewport" but it actually
      captures the entire editor window. This should be clarified.
    file: server/src/tools/screenshot.ts
    lines: [7-8]
    recommendation: |
      Update description to accurately reflect behavior:
      "Capture the editor window while game is running"
    owner: TODO

  - id: TEST-001
    severity: minor
    category: Test Coverage
    title: No unit tests for screenshot tools
    description: |
      The screenshot.ts module has no corresponding test file. While
      integration testing was done manually, unit tests would help
      prevent regressions.
    file: server/src/tools/screenshot.ts
    recommendation: |
      Add server/src/__tests__/screenshot.test.ts with mocked godot
      connection to test tool registration and response transformation.
    owner: TODO

positive_observations:
  - Follows existing codebase patterns consistently
  - Types are properly defined and exported (TextContent, ImageContent, ToolResult)
  - Default max_width prevents buffer overflow issues
  - WebSocket buffer increase is well-documented with comment
  - Error handling for NOT_RUNNING and NO_VIEWPORT cases
  - Image resize uses high-quality INTERPOLATE_LANCZOS

plan:
  goals:
    - Eliminate code duplication (DRY violations)
    - Improve error handling robustness
    - Add test coverage

  tasks:
    - id: task-1
      title: Extract image processing helper in GDScript
      priority: high
      references: [DRY-001]
      owner: TODO

    - id: task-2
      title: Define shared TypeScript types
      priority: medium
      references: [DRY-002, DRY-003]
      owner: TODO

    - id: task-3
      title: Add null checks for image capture
      priority: medium
      references: [ERR-001]
      owner: TODO

    - id: task-4
      title: Fix or remove unused hint parameter
      priority: low
      references: [UNUSED-001]
      owner: TODO

    - id: task-5
      title: Update misleading description
      priority: low
      references: [DOC-001]
      owner: TODO

    - id: task-6
      title: Add unit tests for screenshot tools
      priority: medium
      references: [TEST-001]
      owner: TODO
