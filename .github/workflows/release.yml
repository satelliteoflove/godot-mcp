name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish to npm (skip release-please check)'
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs['server--release_created'] }}
      tag_name: ${{ steps.release.outputs['server--tag_name'] }}
      version: ${{ steps.release.outputs['server--version'] }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: .github/release-please-config.json
          manifest-file: .github/release-please-manifest.json

  update-docs:
    needs: release-please
    if: ${{ !needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Check for open release PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BRANCH=$(gh pr list --repo ${{ github.repository }} --head "release-please--branches--main--components--godot-mcp" --json headRefName --jq '.[0].headRefName // empty')
          echo "branch=$PR_BRANCH" >> $GITHUB_OUTPUT
      - uses: actions/checkout@v4
        if: ${{ steps.check-pr.outputs.branch }}
        with:
          ref: ${{ steps.check-pr.outputs.branch }}
      - uses: actions/setup-node@v4
        if: ${{ steps.check-pr.outputs.branch }}
        with:
          node-version: '22'
      - run: npm ci
        if: ${{ steps.check-pr.outputs.branch }}
        working-directory: server
      - run: npm run generate-docs
        if: ${{ steps.check-pr.outputs.branch }}
        working-directory: server
      - name: Sync version to Godot addon
        if: ${{ steps.check-pr.outputs.branch }}
        run: |
          VERSION=$(node -p "require('./server/package.json').version")
          sed -i "s/^version=.*/version=\"$VERSION\"/" godot/addons/godot_mcp/plugin.cfg
      - name: Commit docs if changed
        if: ${{ steps.check-pr.outputs.branch }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/ README.md server/README.md godot/addons/godot_mcp/plugin.cfg
          git diff --staged --quiet || git commit -m "chore: auto-generate docs and sync addon version"
          git push

  publish:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created || inputs.force_publish }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'
      - run: npm install -g npm@latest
      - run: npm --version
      - run: npm ci
        working-directory: server
      - run: npm run build
        working-directory: server
      - run: npm publish --access public
        working-directory: server
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  upload-addon:
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Create addon zip
        run: |
          cd godot/addons
          zip -r ../../godot-mcp-addon-${{ needs.release-please.outputs.version }}.zip godot_mcp
      - name: Upload addon to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} \
            godot-mcp-addon-${{ needs.release-please.outputs.version }}.zip \
            --clobber
